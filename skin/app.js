function getQueryString(t) { var e = new RegExp("(^|&)" + t + "=([^&]*)(&|$)"), r = window.location.search.substr(1).match(e); return null != r ? decodeURI(r[2]) : null } function trim(t) { return t.replace(/(^\s*)|(\s*$)/g, "") } function ltrim(t) { return t.replace(/(^\s*)/g, "") } function rtrim(t) { return t.replace(/(\s*$)/g, "") } function getCookie(t) { return document.cookie.length > 0 && (c_start = document.cookie.indexOf(t + "="), -1 != c_start) ? (c_start = c_start + t.length + 1, c_end = document.cookie.indexOf(";", c_start), -1 == c_end && (c_end = document.cookie.length), unescape(document.cookie.substring(c_start, c_end))) : "" } function setCookie(t, e, r) { var a = new Date; a.setDate(a.getDate() + r), document.cookie = t + "=" + escape(e) + (null == r ? "" : ";expires=" + a.toGMTString()) } function initCountDown1(t, e) { var r = t, a = window.setInterval(function () { if (r > 0) { r -= 1; var t = Math.floor(r % 60), n = Math.floor(r / 60 % 60), o = Math.floor(r / 3600 % 24); Math.floor(r / 3600 / 24); zero(e, o, 0), zero(e, n, 1), zero(e, t, 2) } else window.clearInterval(a), refreshState() }, 1e3); return a } function initCountDown2(t, e) { var r = t, a = window.setInterval(function () { if (r > 0) { r -= 1; var t = Math.floor(r % 60), n = Math.floor(r / 60 % 60), o = Math.floor(r / 3600 % 24); Math.floor(r / 3600 / 24); zero(e, o, 0), zero(e, n, 1), zero(e, t, 2) } else window.clearInterval(a), refreshState() }, 1e3); return a } function zero(t, e, r) { var a = e < 10 ? "0" + e : e.toString(); for (var n in a) $($(t + " span")[parseInt(n) + 2 * r]).html(a[n]) } function validateForm(t) { var e = !0; return $("#" + t + " .required").each(function () { if ("checkbox" == $(this).attr("type")) { if (e && 0 == validateCheckbox($(this).attr("name"), $(this).attr("title") + "输入错误!")) return void (e = !1) } else if (e && $(this).val().length < 1) return alert($(this).attr("title") + "输入错误!"), $(this).focus(), void (e = !1) }), $("#" + t + " .number").each(function () { if (e && ($(this).val().length < 1 || isNaN($(this).val()))) return alert($(this).attr("title") + "输入错误!"), $(this).focus(), void (e = !1); var t = ($(this).val() + "").split("."); return 2 == t.length && t[1].length >= 8 ? (alert($(this).attr("title") + "错误，不能超过8位小数"), void (e = !1)) : void 0 }), $("#" + t + " .addresses").each(function () { if (e && empty(getInputArray($(this)))) return alert($(this).attr("title") + "输入错误!"), $(this).focus(), void (e = !1) }), $("#" + t + " .numberEmp").each(function () { if (e && $(this).val().length > 0 && isNaN($(this).val())) return alert($(this).attr("title") + "输入错误!"), $(this).focus(), void (e = !1) }), e } function unique(t) { if (Array.isArray(t)) { for (var e = [], r = 0; r < t.length; r++)e.includes(t[r]) || e.push(t[r]); return e } console.log("type error!") } function getInputArray(t) { for (var e = [], r = $(t).val().split(/[,_;& \n"\]]/), a = 0; a < r.length; a++) { var n = trim(r[a]); 42 == n.length && web3.utils.isAddress(n) && e.push(n) } return e = unique(e) } function checkTime(t, e) { var r = { "M+": t.getMonth() + 1, "d+": t.getDate(), "H+": t.getHours(), "m+": t.getMinutes(), "s+": t.getSeconds(), "q+": Math.floor((t.getMonth() + 3) / 3), S: t.getMilliseconds() }; for (var a in /(y+)/.test(e) && (e = e.replace(RegExp.$1, (t.getFullYear() + "").substr(4 - RegExp.$1.length))), r) new RegExp("(" + a + ")").test(e) && (e = e.replace(RegExp.$1, 1 == RegExp.$1.length ? r[a] : ("00" + r[a]).substr(("" + r[a]).length))); return e } function shortAddress(t) { return empty(t) ? "" : t.substr(0, 6) + ".." + t.substr(38) } function Dictionary() { this.items = {} } function empty(t) { try { if (null == t || null == t) return !0; if ("number" == typeof t) return !!isNaN(t); if ("boolean" == typeof t || "function" == typeof t || t instanceof Date || t instanceof RegExp) return !1; if ("string" == typeof t) return 0 == t.trim().length || "null" == t; if ("object" == typeof t) { if (t instanceof Array) return 0 == t.length; if (t instanceof Object) return 0 == Object.getOwnPropertyNames(t).length } } catch (t) { return console.log(t), !1 } } $(function () { new ClipboardJS(".copy", { text: function () { return $(".account0").attr("title") } }).on("success", function (t) { alert("成功复制邀请链接") }), new ClipboardJS(".copyAddress", { text: function (t) { return t.getAttribute("title") } }).on("success", function (t) { alert("成功复制地址") }), web3.eth.getGasPrice(function (t, e) { if (empty(t)) { var r = e / 1e9; $("#gasprice").val(r), console.log(r) } }) }), Dictionary.prototype.has = function (t) { return t in this.items }, Dictionary.prototype.set = function (t, e) { this.items[t] = e }, Dictionary.prototype.remove = function (t) { return !!this.has(t) && (delete this.items[t], !0) }, Dictionary.prototype.get = function (t) { return this.has(t) ? this.items[t] : void 0 }, Dictionary.prototype.keys = function () { var t = []; for (var e in this.items) this.items.hasOwnProperty(e) && t.push(e); return t }, Dictionary.prototype.values = function () { var t = []; for (var e in this.items) this.items.hasOwnProperty(e) && t.push(this.items[e]); return t }, Dictionary.prototype.getItems = function () { return this.items }, Dictionary.prototype.clear = function () { this.items = {} }, Dictionary.prototype.size = function () { var t = 0; for (var e in this.items) this.items.hasOwnProperty(e) && ++t; return t }; var infura = !1, _wei = 1e18, _gas = 3e5 / _wei; function getGasPrice() { var t = 25; return isNaN($("#gasprice").val()) ? t = 25 : $("#gasprice").val() > 250 ? (alert("Gas价格不能超过250"), $("#gasprice").val(25), t = 25) : $("#gasprice").val() < 20 ? (alert("Gas价格不能小于20"), $("#gasprice").val(25), t = 25) : t = $("#gasprice").val(), 1e9 * t / _wei } function to0x(t) { return "0x" + new BigNumber(t).multipliedBy(_wei).toString(16) } function to10(t) { return new BigNumber(t).dividedBy(_wei).toString(10) } function showValue(t) { return empty(t) ? "--" : parseFloat(t.toFixed(6)) } function showValue9(t) { if (empty(t)) return "--"; var e = parseFloat((Number(t) / _wei).toFixed(6)) + ""; return e.length > 9 ? e.substr(0, 9) : e } function getPrivateKey() { var t = priv.get(accounts[0]); return empty(t) ? (alert("没有测试的私钥"), null) : t } function sendAsyncWithPriv(t, e, r) { var a = MyContract.methods.invest(accounts[0]).encodeABI(), n = { from: accounts[0], to: contractAddress, value: to0x(t), gas: to0x(_gas), data: a }; web3.eth.accounts.signTransaction(n, getPrivateKey()).then(t => { var e = web3.eth.sendSignedTransaction(t.rawTransaction); e.on("confirmation", (t, e) => { console.log("confirmation: " + t) }), e.on("transactionHash", t => { console.log("hash"), console.log(t) }), e.on("receipt", t => { console.log("reciept"), console.log(t) }), e.on("error", console.error) }) } function sendAsync(t, e, r) { ethereum.sendAsync({ method: "eth_sendTransaction", params: [{ from: accounts[0], to: e, value: to0x(t), gasPrice: to0x(getGasPrice()), gas: to0x(_gas), data: r }] }, (t, e) => t ? (console.error(t), null) : (console.log(e), e)) } let accounts = []; var priv = new Dictionary; infura ? web3 = new Web3(new Web3.providers.WebsocketProvider("wss://Rinkeby.infura.io/ws/v3/ab68c8eee9954d3d989ac1422fb79a9f")) : "undefined" != typeof web3 ? web3 = new Web3(web3.currentProvider) : alert("please use imtoken ,trustwallet"); var InterValObj1, InterValObj2, MyContract = new web3.eth.Contract(contractAbi, contractAddress), selfInfo = null, rest = 0, myEvent = MyContract.events.log({ filter: {}, fromBlock: 0 }, function (t, e) { }).on("data", function (t) { console.log(t.returnValues) }).on("changed", function (t) { }).on("error", console.error); async function getAccount() { accounts = await ethereum.enable(), refreshState() } getAccount(); try { ethereum.on("accountsChanged", function (t) { accounts = t, refreshState() }) } catch (t) { } var dailyRate = [.008, .01, .011, .012], maxMul = [2.2, 2.5, 3, 3.5]; function getOverflowRest(t, e) { var r = getLevel(t); return t * maxMul[r] - e } function getDaily(t) { var e = t * dailyRate[getLevel(t)]; return e > .12 && (e = .12), e } function getLevel(t) { return t < 2 ? 0 : t < 5 ? 1 : t < 10 ? 2 : 3 } function refreshState() { var t = document.location.protocol + "//" + document.location.host + document.location.pathname + "?r=" + accounts[0]; $(".account0").html(t), $(".account0").attr("title", t), MyContract.methods.selfInfo().call({ from: accounts[0] }).then(function (t) { selfInfo = t, $("#donateBatch #addresses,#settleBatch #addresses").val(accounts[0] + "\n"), $("._blance").html(showValue(t.r[1] / _wei)), $("._blanceERC20").html(showValue(t.r[2] / _wei)), $("._totalInvA").html(showValue(t.r[3] / _wei)), $("._totalInvB").html(showValue(t.r[4] / _wei)), $("._renum").html(t.r[5]), $("._incomeStatic").html(showValue(t.r[6] / _wei)), $("._incomeRef").html(showValue(t.r[7] / _wei)), $("input._twtSaleNum").val(showValue(t.r[8] / _wei)), $("span._twtSaleNum").html(showValue(t.r[8] / _wei)), $("._twtSalePrice").val(showValue(t.r[9] / _wei)), $("._win").html(showValue(t.r[10] / _wei)), $("._CRInvA").html(showValue(t.r[11] / _wei)), $("._CRReB").html(showValue(t.r[12] / _wei)); var e = empty(t._refAddr) ? getRef() : t._refAddr; $("._refAddr").html(shortAddress(e)), $("._refAddr").attr("title", e), $("._aLevel").html(t.r[14]), $("._aLevelRest").html(showValue(t.r[15] / _wei)), $("._curNum").html(showValue(t.r[16] / _wei)), $("._rankAPool").html(showValue9(t.r[19])), $("._rankBPool").html(showValue9(t.r[20])); var r = Date.parse(new Date) / 1e3; (n = parseInt((r - Number(t.r[13])) / interval)) <= 0 && t.r[22] > 0 ? ($("._maxCRInvA").html(showValue(t.r[22] / _wei)), $("._maxInvA").html(shortAddress(t._maxInvA)), $("._maxInvA").attr("title", t._maxInvA)) : ($("._maxCRInvA").html("0"), $("._maxInvA").html(shortAddress("0x0000000000000000000000000000000000000000"))), n <= 0 && t.r[23] > 0 ? ($("._maxCRReB").html(showValue(t.r[23] / _wei)), $("._maxReB").html(shortAddress(t._maxReB)), $("._maxReB").attr("title", t._maxReB)) : ($("._maxCRReB").html("0"), $("._maxReB").html(shortAddress("0x0000000000000000000000000000000000000000"))), window.clearInterval(InterValObj1), window.clearInterval(InterValObj2); var a = interval - (r - Number(t.r[13])) % interval; if (InterValObj1 = initCountDown1(a, "#remainTime"), t.r[0] > 0) { InterValObj2 = initCountDown2(interval - (r - t.r[0]) % interval, "#remainTimeB"); var n = Math.floor((r - t.r[0]) / interval), o = getDaily(t.r[4] / _wei) * n; (rest = getOverflowRest(t.r[4] / _wei, t.r[6] / _wei)) < o && (o = rest), $("._curDaily").html(showValue(o)), 0 == o && (n = 0), n > 0 ? ($("._days").removeClass("hide"), $("._days").html(n)) : ($("._days").addClass("hide"), $("._days").html(n)) } else $("._curDaily").html(showValue(0)), $("._days").addClass("hide"), $("._days").html(0) }) } function playA(t) { validateForm("playA") && ($("#playA #num").val() >= .1 ? ($(t).attr("disabled", !0), callback(t, MyContract.methods.playA(getRef()).send({ from: accounts[0], value: to0x($("#playA #num").val()), gasPrice: to0x(getGasPrice()), gas: to0x(35e4 / _wei) }))) : alert("投资额不能少于0.1ETH")) } function playB(t) { if (validateForm("playB")) { var e = $("#playB #num").val(); if (e >= .5) { if (10 * selfInfo.r[2] < e * selfInfo.r[16]) return void alert("TWT门票可能不够"); if (parseFloat($("._curDaily").text()) > 0 && !confirm("您有未结算收益,投资后将推迟。确定继续?")) return; $(t).attr("disabled", !0), callback(t, MyContract.methods.playB(getRef()).send({ from: accounts[0], value: to0x($("#playB #num").val()), gasPrice: to0x(getGasPrice()), gas: to0x(45e4 / _wei) })) } else alert("投资额不能少于0.5ETH") } } function donate(t) { !empty(selfInfo) && selfInfo.r[1] > 0 ? ($(t).attr("disabled", !0), callback(t, MyContract.methods.donate().send({ from: accounts[0], gasPrice: to0x(getGasPrice()), gas: to0x(9e4 / _wei) }))) : alert("您的余额为0ETH") } function donateBatch(t) { var e = getInputArray("#donateBatch #addresses"); empty(e) || e.length < 1 ? alert("批量地址不能为空") : ($(t).attr("disabled", !0), MyContract.methods.verifyAddress(1, e).call({ from: accounts[0] }).then(function (r) { console.log(r), $(t).attr("disabled", !1), empty(e = r) || e.length < 1 ? alert("您输入的都是无余额的地址") : e.length > 200 ? alert("批量地址不能超过200个") : confirm("有余额的有效地址个数为：" + e.length) && ($(t).attr("disabled", !0), callback(t, MyContract.methods.donateBatch(e).send({ from: accounts[0], gasPrice: to0x(getGasPrice()), gas: to0x((7e4 + 4e4 * e.length) / _wei) }))) }).catch(function (e) { console.log("地址检验出错了!" + e), $(t).attr("disabled", !1) })) } function settle(t) { if (0 != selfInfo.r[0]) if (rest <= 0) alert("您的收益已经到达最大值"); else { var e = Date.parse(new Date) / 1e3; Math.floor((e - selfInfo.r[0]) / interval) < 1 ? alert("您还没到结算时间") : ($(t).attr("disabled", !0), callback(t, MyContract.methods.settle().send({ from: accounts[0], gasPrice: to0x(getGasPrice()), gas: to0x(22e4 / _wei) }))) } else alert("您还没开启契约世界") } function settleBatch(t) { var e = getInputArray("#settleBatch #addresses"); empty(e) || e.length < 1 ? alert("批量地址不能为空") : ($(t).attr("disabled", !0), MyContract.methods.verifyAddress(2, e).call({ from: accounts[0] }).then(function (r) { console.log(r), $(t).attr("disabled", !1), empty(e = r) || e.length < 1 ? alert("您输入的都是无需结算的地址") : e.length > 100 ? alert("批量地址不能超过100个") : confirm("有效结算地址个数为：" + e.length) && ($(t).attr("disabled", !0), callback(t, MyContract.methods.settleBatch(e).send({ from: accounts[0], gasPrice: to0x(getGasPrice()), gas: to0x((17e4 + 1e5 * e.length) / _wei) }))) }).catch(function (e) { console.log("地址检验出错了!" + e), $(t).attr("disabled", !1) })) } function buyTWT(t) { if (validateForm("buyTWT")) { var e = $("#buyTWT #num").val(), r = $("#buyTWT #price").val(), a = (e * r).toFixed(8); if (r < 1e-6) return void alert("买入价格不能小于0.000001ETH"); if (a < .5) return void alert("买入额不能小于0.5ETH"); var n = getInputArray("#buyTWT #addresses"); if (empty(n) || n.length < 1) return void alert("批量地址不能为空"); if (n.length > 100) return void alert("批量地址不能超过100个"); if (!confirm("有效的地址个数为：" + n.length)) return; $(t).attr("disabled", !0), a = (a -= selfInfo.r[1] / _wei) < 0 ? 0 : a, callback(t, MyContract.methods.buyTWT(to0x(e), to0x(r), n).send({ from: accounts[0], value: to0x(a), gasPrice: to0x(getGasPrice()), gas: to0x((15e4 + 2e4 * n.length) / _wei) })) } } function saleTWT(t) { if (validateForm("saleTWT")) { var e = $("#saleTWT #num").val(), r = $("#saleTWT #price").val(); if (0 == e) confirm("确认撤销挂单吗") && ($(t).attr("disabled", !0), callback(t, MyContract.methods.saleTWT(to0x(0), to0x(0)).send({ from: accounts[0], gasPrice: to0x(getGasPrice()), gas: to0x(5e4 / _wei) }))); else { if (e * r < .5) return void alert("卖出额不能小于0.5ETH"); if (e * _wei > Number(selfInfo.r[2]) + Number(selfInfo.r[8])) return void alert("TWT余额不足"); if (e * _wei == Number(selfInfo.r[8]) && r * _wei == Number(selfInfo.r[9])) return alert("没有更改卖单信息"), void $(".modal").modal("hide"); $(t).attr("disabled", !0), callback(t, MyContract.methods.saleTWT(to0x(e), to0x(r)).send({ from: accounts[0], gasPrice: to0x(getGasPrice()), gas: to0x(12e4 / _wei) })) } } } function callback(t, e) { e.on("transactionHash", function (t) { }).on("confirmation", function (e, r) { console.log(2), refreshState(), $(t).attr("disabled", !1), $(".modal").modal("hide") }).on("receipt", function (e) { console.log(3), refreshState(), $(t).attr("disabled", !1), $(".modal").modal("hide") }).on("error", function (e) { console.log(e), $(t).attr("disabled", !1), $(".modal").modal("hide"), alert("合约执行失败，请检查后提交") }) } var ref = getQueryString("r"); function getRef() { return web3.utils.isAddress(getCookie("ref")) ? getCookie("ref") : firstAddr } web3.utils.isAddress(ref) && setCookie("ref", ref, 3650);